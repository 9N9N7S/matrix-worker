{
  "$schema": "node_modules/wrangler/config-schema.json",
  "name": "matrix-worker",
  "main": "src/index.ts",
  "compatibility_date": "2024-11-01",
  "compatibility_flags": ["nodejs_compat"],
  "account_id": "1d9fd7c003b9fca90cd19fcb8ad02941",

  "observability": {
    "enabled": true
  },

  // D1 Database for relational data (users, rooms, events, memberships)
  "d1_databases": [
    {
      "binding": "DB",
      "database_name": "tuwunel-db",
      "database_id": "16b1f2dd-1a33-43ce-8e4b-26700c2c5397"
    }
  ],

  // KV Namespaces for fast lookups
  "kv_namespaces": [
    {
      "binding": "SESSIONS",
      "id": "a43e9fbeee284c8d9e53c8cb22c4668f"
    },
    {
      "binding": "DEVICE_KEYS",
      "id": "129d6a676e4d48e5ab9a87167b81f989"
    },
    {
      "binding": "CACHE",
      "id": "d501c7364d2a4abbb85b53d45160d2c7"
    },
    {
      "binding": "CROSS_SIGNING_KEYS",
      "id": "d434511aee4a4652b6c0be1e84e11132"
    },
    {
      "binding": "ACCOUNT_DATA",
      "id": "d6f70c1315044621b49cb1d6588f7770"
    },
    {
      "binding": "ONE_TIME_KEYS",
      "id": "8b073a7021b04be683d620aff2fbc748"
    }
  ],

  // R2 Bucket for media storage
  "r2_buckets": [
    {
      "binding": "MEDIA",
      "bucket_name": "tuwunel-media"
    }
  ],

  // Durable Objects for real-time sync and room coordination
  "durable_objects": {
    "bindings": [
      {
        "name": "ROOMS",
        "class_name": "RoomDurableObject"
      },
      {
        "name": "SYNC",
        "class_name": "SyncDurableObject"
      },
      {
        "name": "FEDERATION",
        "class_name": "FederationDurableObject"
      },
      {
        "name": "CALL_ROOMS",
        "class_name": "CallRoomDurableObject"
      },
      {
        "name": "ADMIN",
        "class_name": "AdminDurableObject"
      },
      {
        "name": "USER_KEYS",
        "class_name": "UserKeysDurableObject"
      },
      {
        "name": "PUSH",
        "class_name": "PushDurableObject"
      },
      {
        "name": "RATE_LIMIT",
        "class_name": "RateLimitDurableObject"
      }
    ]
  },

  "migrations": [
    {
      "tag": "v1",
      "new_sqlite_classes": ["RoomDurableObject", "SyncDurableObject", "FederationDurableObject"]
    },
    {
      "tag": "v2",
      "new_classes": ["CallRoomDurableObject"]
    },
    {
      "tag": "v3",
      "new_classes": ["AdminDurableObject"]
    },
    {
      "tag": "v4",
      "new_classes": ["UserKeysDurableObject"]
    },
    {
      "tag": "v5",
      "new_classes": ["PushDurableObject"]
    },
    {
      "tag": "v6",
      "new_classes": ["RateLimitDurableObject"]
    }
  ],

  // Environment variables
  "vars": {
    "SERVER_NAME": "m.easydemo.org",
    "SERVER_VERSION": "0.1.0",
    "TURN_KEY_ID": "42586a3b6b8415d1e69e825f169f3108",
    "LIVEKIT_API_KEY": "devkey",
    "LIVEKIT_URL": "wss://livekit.easydemo.org"
  },

  // Secrets should be set using:
  // npx wrangler secret put TURN_API_TOKEN
  // npx wrangler secret put CALLS_APP_ID
  // npx wrangler secret put CALLS_APP_SECRET
  // npx wrangler secret put LIVEKIT_API_SECRET
  //
  // For email verification (3PID) via Cloudflare Email Service:
  // npx wrangler secret put EMAIL_FROM       # From address (e.g., "noreply@m.easydemo.org")
  //
  // For direct APNs push notifications (optional - bypasses Sygnal):
  // npx wrangler secret put APNS_KEY_ID      # Key ID from Apple Developer Portal
  // npx wrangler secret put APNS_TEAM_ID     # Apple Developer Team ID
  // npx wrangler secret put APNS_PRIVATE_KEY # Contents of .p8 file
  // npx wrangler secret put APNS_ENVIRONMENT # "production" or "sandbox" (default: production)
  //
  // To create a Cloudflare Realtime SFU app:
  // 1. Go to https://dash.cloudflare.com/?to=/:account/calls
  // 2. Create a new Realtime App
  // 3. Copy the App ID and App Secret
  // Or use the API: https://developers.cloudflare.com/api/resources/calls/subresources/sfu/methods/create/

  // Custom domain routing
  "routes": [
    {
      "pattern": "m.easydemo.org",
      "custom_domain": true
    }
  ],

  // Workers VPC for LiveKit connectivity 
  "vpc_services": [
    {
      "binding": "LIVEKIT_API",
      "service_id": "019c77ee-ac33-7380-906c-9bbfd73dadfb"
    }
  ],

  // Cloudflare Email Service for 3PID email verification
  "send_email": [{ "name": "EMAIL", "remote": true }],

  // Cloudflare Workflows for durable multi-step operations
  "workflows": [
    {
      "name": "room-join-workflow",
      "binding": "ROOM_JOIN_WORKFLOW",
      "class_name": "RoomJoinWorkflow"
    },
    {
      "name": "push-notification-workflow",
      "binding": "PUSH_NOTIFICATION_WORKFLOW",
      "class_name": "PushNotificationWorkflow"
    }
  ]
"migrations": [
  {
    "tag": "v1",
    "new_sqlite_classes": [
      "RoomDurableObject",
      "SyncDurableObject",
      "FederationDurableObject",
      "CallRoomDurableObject",
      "AdminDurableObject",
      "UserKeysDurableObject",
      "PushDurableObject",
      "RateLimitDurableObject"
    ]
  }
]
}
